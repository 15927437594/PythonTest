# -*- coding: utf-8 -*-
"""
user:Created by jid on 2021/11/10 13:36
email:jid@hwtc.com.cn
description:
"""
import numpy as np
from matplotlib import pyplot as plt
from scipy.fft import fft, fftfreq
from scipy.spatial import distance


def normalize_audio(single_channel_audio, amplitude=32767):
    normal_audio = (single_channel_audio - 32768) / amplitude
    return normal_audio


def cal_fft_cos_distance(single_channel_audio, audio_fs=44100, reference_frequency=20000.0, threshold=0.01):
    N = len(single_channel_audio)
    T = 1.0 / audio_fs
    x = np.linspace(0.0, N * T, N, endpoint=False)

    # 生成参考信号
    x = np.linspace(0.0, N * T, N, endpoint=False)
    y_ref = np.sin(reference_frequency * 2.0 * np.pi * x)
    yf_ref = fft(y_ref)
    xf = fftfreq(N, T)[:N // 2]
    yf = fft(single_channel_audio)

    plt.plot(xf, 2.0 / N * np.abs(yf[0:N // 2]))
    plt.grid()
    plt.show()

    plt.plot(x[0:200], single_channel_audio[0:200])
    plt.grid()
    plt.show()

    dist = distance.cosine(np.abs(yf[0:N // 2]), np.abs(yf_ref[0:N // 2]))
    # ret = 0
    if dist > threshold:
        ret = 0
    else:
        ret = 1

    return ret, dist


def main():
    ad_data = [32731, 32732, 32731, 32731, 32731, 32732, 32732, 32731, 32732, 32732, 32732, 32731, 32732, 32731, 32732,
               32732, 32733, 32731, 32731, 32731, 32731, 32731, 32730, 32731, 32731, 32732, 32733, 32731, 32731, 32732,
               32732, 32732, 32732, 32732, 32732, 32732, 32731, 32734, 32732, 32732, 32730, 32731, 32731, 32732, 32732,
               32731, 32731, 32731, 32731, 32732, 32732, 32731, 32733, 32732, 32732, 32732, 32731, 32733, 32732, 32731,
               32732, 32731, 32730, 32731, 32731, 32730, 32731, 32731, 32731, 32731, 32731, 32732, 32732, 32731, 32732,
               32731, 32732, 32731, 32733, 32733, 32732, 32730, 32730, 32731, 32732, 32731, 32732, 32731, 32732, 32732,
               32731, 32731, 32731, 32733, 32731, 32732, 32731, 32731, 32733, 32733, 32731, 32733, 32732, 32731, 32732,
               32731, 32731, 32732, 32733, 32733, 32733, 32731, 32730, 32731, 32731, 32732, 32730, 32730, 32730, 32731,
               32731, 32732, 32732, 32731, 32733, 32733, 32732, 32731, 32730, 32731, 32731, 32732, 32730, 32730, 32732,
               32732, 32731, 32732, 32731, 32730, 32732, 32732, 32731, 32731, 32733, 32732, 32732, 32733, 32731, 32732,
               32731, 32732, 32732, 32731, 32732, 32731, 32731, 32731, 32731, 32731, 32731, 32730, 32730, 32731, 32732,
               32731, 32732, 32731, 32731, 32733, 32731, 32730, 32731, 32733, 32732, 32732, 32732, 32730, 32731, 32732,
               32731, 32731, 32731, 32732, 32731, 32731, 32733, 32732, 32731, 32731, 32732, 32732, 32731, 32730, 32732,
               32731, 32732, 32731, 32731, 32732, 32732, 32731, 32731, 32731, 32731, 32732, 32731, 32731, 32733, 32731,
               32731, 32732, 32732, 32731, 32733, 32733, 32731, 32731, 32732, 32731, 32732, 32732, 32731, 32732, 32732,
               32731, 32732, 32730, 32731, 32730, 32731, 32732, 32730, 32731, 32733, 32732, 32732, 32732, 32731, 32731,
               32732, 32731, 32731, 32733, 32732, 32732, 32730, 32732, 32732, 32732, 32731, 32731, 32731, 32731, 32732,
               32731, 32730, 32731, 32731, 32730, 32731, 32731, 32732, 32733, 32733, 32733, 32733, 32732, 32732, 32732,
               32732, 32731, 32732, 32730, 32731, 32730, 32732, 32731, 32733, 32733, 32732, 32731, 32731, 32731, 32732,
               32731, 32733, 32733, 32732, 32732, 32732, 32730, 32733, 32732, 32730, 32731, 32731, 32731, 32731, 32731,
               32732, 32732, 32731, 32732, 32731, 32732, 32732, 32732, 32732, 32731, 32730, 32731, 32732, 32732, 32732,
               32732, 32731, 32731, 32731, 32732, 32732, 32731, 32732, 32731, 32731, 32730, 32732, 32732, 32731, 32732,
               32731, 32730, 32731, 32731, 32732, 32731, 32731, 32730, 32732, 32732, 32731, 32731, 32733, 32731, 32731,
               32732, 32731, 32733, 32732, 32731, 32733, 32732, 32731, 32731, 32732, 32731, 32731, 32732, 32732, 32731,
               32732, 32731, 32731, 32731, 32731, 32731, 32733, 32732, 32731, 32732, 32732, 32732, 32731, 32732, 32731,
               32731, 32732, 32732, 32731, 32729, 32730, 32732, 32731, 32732, 32731, 32733, 32731, 32732, 32733, 32731,
               32732, 32731, 32730, 32732, 32732, 32732, 32732, 32732, 32733, 32733, 32732, 32732, 32731, 32732, 32731,
               32731, 32731, 32732, 32731, 32732, 32731, 32731, 32731, 32732, 32732, 32731, 32730, 32731, 32732, 32732,
               32731, 32730, 32732, 32731, 32732, 32731, 32731, 32731, 32731, 32730, 32731, 32732, 32732, 32731, 32731,
               32732, 32733, 32733, 32731, 32730, 32731, 32732, 32733, 32732, 32732, 32731, 32732, 32731, 32731, 32732,
               32733, 32731, 32730, 32732, 32731, 32731, 32731, 32731, 32733, 32730, 32732, 32732, 32733, 32732, 32732,
               32731, 32732, 32731, 32732, 32732, 32731, 32731, 32732, 32731, 32731, 32731, 32731, 32731, 32732, 32732,
               32730, 32731, 32730, 32730, 32731, 32732, 32731, 32731, 32730, 32731, 32731, 32731, 32732, 32732, 32732,
               32730, 32731, 32731, 32733, 32733, 32732, 32732, 32732, 32730, 32732, 32732, 32731, 32731, 32731, 32732,
               32731, 32732, 32732, 32733, 32732, 32732, 32732, 32732, 32732, 32733, 32732, 32732, 32731, 32731, 32731,
               32731, 32731, 32729, 32730, 32732, 32731, 32732, 32733, 32731, 32732, 32731, 32732, 32731, 32731, 32731,
               32732, 32731, 32732, 32731, 32732, 32731, 32730, 32732, 32732, 32731, 32731, 32731, 32731, 32732, 32731,
               32731, 32732, 32732, 32732, 32730, 32731, 32732, 32732, 32730, 32732, 32731, 32730, 32732, 32732, 32733,
               32732, 32731, 32732, 32732, 32731, 32731, 32731, 32730, 32733, 32731, 32731, 32731, 32731, 32730, 32733,
               32731, 32731, 32731, 32731, 32731, 32732, 32731, 32731, 32732, 32729, 32731, 32731, 32730, 32731, 32731,
               32730, 32731, 32731, 32731, 32730, 32731, 32731, 32731, 32733, 32733, 32731, 32731, 32731, 32731, 32731,
               32730, 32731, 32732, 32733, 32732, 32731, 32731, 32731, 32732, 32732, 32733, 32732, 32732, 32732, 32732,
               32731, 32731, 32732, 32733, 32732, 32733, 32731, 32731, 32731, 32731, 32732, 32730, 32732, 32733, 32732,
               32732, 32730, 32730, 32731, 32732, 32731, 32731, 32731, 32732, 32731, 32731, 32731, 32732, 32731, 32731,
               32731, 32731, 32731, 32731, 32732, 32733, 32731, 32732, 32730, 32731, 32732, 32731, 32732, 32731, 32732,
               32731, 32731, 32732, 32732, 32731, 32733, 32733, 32731, 32730, 32732, 32732, 32731, 32731, 32731, 32732,
               32732, 32731, 32732, 32730, 32731, 32731, 32730, 32732, 32732, 32733, 32731, 32731, 32731, 32732, 32731,
               32730, 32732, 32732, 32732, 32730, 32732, 32731, 32731, 32732, 32732, 32732, 32733, 32731, 32731, 32732,
               32732, 32732, 32732, 32733, 32731, 32732, 32731, 32731, 32732, 32732, 32733, 32733, 32732, 32730, 32732,
               32731, 32733, 32733, 32733, 32731, 32731, 32731, 32732, 32732, 32733, 32733, 32731, 32731, 32731, 32731,
               32732, 32732, 32731, 32730, 32731, 32730, 32731, 32731, 32731, 32733, 32732, 32730, 32731, 32732, 32731,
               32733, 32732, 32731, 32730, 32732, 32731, 32732, 32733, 32731, 32732, 32731, 32731, 32732, 32733, 32732,
               32732, 32731, 32731, 32732, 32733, 32730, 32731, 32732, 32731, 32730, 32731, 32732, 32731, 32733, 32732,
               32731, 32731, 32731, 32731, 32730, 32731, 32731, 32732, 32732, 32732, 32731, 32732, 32732, 32732, 32731,
               32731, 32731, 32731, 32731, 32732, 32731, 32733, 32733, 32732, 32733, 32733, 32733, 32732, 32730, 32733,
               32731, 32732, 32730, 32731, 32732, 32731, 32732, 32731, 32732, 32731, 32733, 32732, 32731, 32732, 32732,
               32730, 32730, 32731, 32731, 32733, 32732, 32730, 32731, 32731, 32731, 32732, 32732, 32732, 32733, 32732,
               32732, 32731, 32732, 32733, 32732, 32732, 32731, 32731, 32731, 32731, 32732, 32732, 32731, 32731, 32732,
               32731, 32731, 32731, 32733, 32732, 32731, 32733, 32731, 32730, 32731, 32731, 32732, 32732, 32732, 32731,
               32731, 32731, 32731, 32732, 32731, 32732, 32732, 32732, 32732, 32732, 32731, 32732, 32732, 32732, 32731,
               32732, 32733, 32732, 32730, 32731, 32731, 32732, 32732, 32731, 32731, 32731, 32731, 32732, 32732, 32732,
               32731, 32731, 32731, 32732, 32731, 32731, 32731, 32732, 32734, 32733, 32731, 32732, 32732, 32732, 32732,
               32731, 32731, 32732, 32732, 32732, 32732, 32732, 32732, 32732, 32732, 32733, 32732, 32732, 32733, 32732,
               32731, 32732, 32731, 32732, 32732, 32732, 32731, 32732, 32733, 32732, 32732, 32731, 32731, 32731, 32730,
               32732, 32732, 32732, 32732, 32731, 32731, 32731, 32729, 32730, 32730, 32732, 32732, 32733, 32732, 32733,
               32732, 32731, 32731, 32731, 32732, 32731, 32733, 32732, 32731, 32732, 32731, 32730, 32730, 32731, 32733,
               32731, 32732, 32733, 32733, 32732, 32731, 32731, 32731, 32731, 32731, 32732, 32731, 32732, 32732, 32731,
               32731, 32732, 32732, 32732, 32731, 32732, 32732, 32733, 32731, 32731, 32731, 32732, 32731, 32731, 32731,
               32730, 32730, 32732, 32732, 32731, 32731, 32732, 32730, 32732, 32732, 32733, 32731, 32733, 32732, 32730,
               32731, 32731, 32732, 32731, 32731, 32731, 32730, 32730, 32731, 32731, 32731, 32731, 32732, 32733, 32733,
               32732, 32732, 32733, 32733, 32731, 32731, 32732, 32732, 32732, 32732, 32731, 32730, 32732, 32731, 32731,
               32732, 32732, 32730, 32731, 32731, 32730, 32731, 32730, 32731, 32733, 32731, 32731, 32731, 32731, 32732,
               32732, 32734, 32733, 32732, 32730, 32732, 32731, 32731, 32732, 32731, 32731, 32731, 32730, 32731, 32730,
               32731, 32731, 32731, 32731, 32731, 32732, 32731, 32732, 32730, 32732, 32732, 32732, 32733, 32732, 32732,
               32732, 32731, 32732, 32731, 32733, 32732, 32733, 32732, 32732, 32731, 32731, 32730, 32732, 32733, 32732,
               32731, 32733, 32731, 32732, 32733, 32733, 32733, 32731, 32732, 32731, 32731, 32732, 32734, 32731, 32732,
               32731, 32732, 32731, 32732, 32731, 32731, 32731, 32731, 32731, 32731, 32730, 32729, 32731, 32732, 32732,
               32732, 32733, 32732, 32732, 32731, 32730, 32733, 32731, 32732, 32732, 32734, 32732, 32732, 32731, 32730,
               32731, 32732, 32731, 32733, 32733, 32733, 32731, 32732, 32733, 32733, 32732, 32732, 32733, 32733, 32733,
               32732, 32731, 32731, 32732, 32732, 32732, 32730, 32731, 32733, 32733, 32731, 32731, 32731, 32732, 32733,
               32732, 32731, 32730, 32732, 32731, 32732, 32731, 32731, 32730, 32731, 32732, 32732, 32732, 32733, 32732,
               32734, 32732, 32732, 32731, 32731, 32733, 32734, 32732, 32732, 32732, 32732, 32733, 32733, 32731, 32732,
               32732, 32732, 32731, 32731, 32730, 32731, 32731, 32731, 32731, 32731, 32732, 32732, 32731, 32732, 32731,
               32732, 32731, 32731, 32732, 32731, 32733, 32734, 32732, 32731, 32731, 32731, 32732, 32732, 32730, 32731,
               32731, 32729, 32732, 32733, 32732, 32732, 32731, 32730, 32731, 32731, 32733, 32734, 32733, 32733, 32730,
               32731, 32732, 32732, 32731, 32731, 32731, 32732, 32731, 32731, 32731, 32732, 32731, 32733, 32734, 32733,
               32732, 32731, 32732, 32732, 32731, 32730, 32731, 32731, 32731, 32731, 32732, 32732, 32732, 32730, 32731,
               32730, 32731, 32731, 32731, 32731, 32732, 32733, 32731, 32731, 32732, 32732, 32731, 32733, 32734, 32732,
               32731, 32732, 32732, 32732, 32733, 32732, 32732, 32732, 32732, 32732, 32732, 32733, 32731, 32733, 32732,
               32732, 32732, 32732, 32732, 32733, 32732, 32731, 32732, 32731, 32732, 32730, 32730, 32732, 32730, 32731,
               32732, 32732, 32731, 32733, 32732, 32730, 32733, 32732, 32732, 32732]

    aud_normal = normalize_audio(np.array(ad_data))
    ret, dist1 = cal_fft_cos_distance(single_channel_audio=aud_normal, reference_frequency=1000.0)
    print('ret = ', ret)
    print('dist1 = ', dist1)


if __name__ == '__main__':
    main()
